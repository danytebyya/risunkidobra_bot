import re, json

from datetime import date
from aiogram import Router, F
from aiogram.types import CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton

from utils.database.db import fetch_daily_quote, upsert_daily_quote
from utils.chatgpt.gpt import generate_daily_quote_model
from handlers.core.subscription import is_subscribed
from handlers.core.start import START_TEXT, get_main_menu_kb
from config import SUPPORT_URL
from utils.utils import safe_call_answer


router = Router()


# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ†Ğ¸Ñ‚Ğ°Ñ‚Ñ‹
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
async def format_quote_message(quote: str, source: str | None) -> tuple[str, dict]:
    """
    Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµÑ‚ Markdown-Ñ‚ĞµĞºÑÑ‚ Ğ¸ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ñ†Ğ¸Ñ‚Ğ°Ñ‚Ñ‹.
    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ĞºĞ¾Ñ€Ñ‚ĞµĞ¶ (text, kwargs), Ğ³Ğ´Ğµ kwargs ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ reply_markup Ğ¸ parse_mode.
    """
    text = f"ğŸ’¬ *Ğ¦Ğ¸Ñ‚Ğ°Ñ‚Ğ° Ğ´Ğ½Ñ*:\n\n_{quote}_"
    if source:
        text += f"\n\n_{source}_"

    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ  Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğ² Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ", callback_data="main_menu_quote")]
    ])
    return text, {"reply_markup": kb, "parse_mode": "Markdown"}


# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Â«Ğ¦Ğ¸Ñ‚Ğ°Ñ‚Ğ° Ğ´Ğ½ÑÂ»
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
@router.callback_query(F.data == "quote_of_day")
async def quote_of_day_handler(call: CallbackQuery):
    """
    ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Â«Ğ¦Ğ¸Ñ‚Ğ°Ñ‚Ñƒ Ğ´Ğ½ÑÂ» Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:
    â€” ĞµÑĞ»Ğ¸ ÑƒĞ¶Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ°, Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ñ‚ ĞµÑ‘;
    â€” Ğ¸Ğ½Ğ°Ñ‡Ğµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ, Ğ·Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµÑ‚, ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ Ğ¸ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²ÑƒÑ;
    â€” Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ Ğ¿Ñ€ĞµĞ´Ğ»Ğ°Ğ³Ğ°ĞµÑ‚ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚ÑŒ.
    """
    user_id = call.from_user.id
    today = date.today().isoformat()

    existing = await fetch_daily_quote(user_id, today)
    if existing:
        quote, source = existing
        text, extra = await format_quote_message(quote, source)
        await call.message.edit_text(text, **extra)
        await call.answer()
        return

    if not await is_subscribed(user_id):
        kb = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="Ğ§Ñ‚Ğ¾ Ğ·Ğ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°?", callback_data="subscription")],
            [InlineKeyboardButton(text="ğŸ  Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğ² Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ", callback_data="main_menu_edit_quote")]
        ])
        await call.message.edit_text(
            text="Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Â«Ğ¦Ğ¸Ñ‚Ğ°Ñ‚Ñƒ Ğ´Ğ½ÑÂ» Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ¸Ğµ Ğ¿Ñ€Ğ¸Ğ²Ğ¸Ğ»ĞµĞ³Ğ¸Ğ¸, Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ Ğ”Ğ¾Ğ±Ñ€Ñ‹Ğµ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¾Ñ‡ĞºĞ¸+ ğŸ«¶",
            reply_markup=kb
        )
        return

    try:
        raw = await generate_daily_quote_model()
        if isinstance(raw, str):
            m = re.search(r"```json\s*(\{[\s\S]*?})\s*```", raw, re.DOTALL)
            json_str = m.group(1) if m else raw.strip("` \n")
            data = json.loads(json_str)
        else:
            data = raw
        quote = data.get("quote", "").strip("` \n")
        source = data.get("source") or None
    except (json.JSONDecodeError, AttributeError, TypeError):
        kb = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="ğŸ”„ ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ½Ğ¾Ğ²Ğ°", callback_data="quote_of_day")],
            [InlineKeyboardButton(text="âœ‰ï¸ ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ² Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºÑƒ", url=SUPPORT_URL)],
            [InlineKeyboardButton(text="ğŸ  Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğ² Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ", callback_data="main_menu_quote")]
        ])
        await call.message.edit_text(
            text="âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ñ†Ğ¸Ñ‚Ğ°Ñ‚Ñƒ. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ÑĞ½Ğ¾Ğ²Ğ° Ğ¸Ğ»Ğ¸ ÑĞ²ÑĞ¶Ğ¸Ñ‚ĞµÑÑŒ Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹.",
            reply_markup=kb
        )
        await call.answer()
        return

    await upsert_daily_quote(user_id, today, quote, source)
    text, extra = await format_quote_message(quote, source)
    await call.message.edit_text(text, **extra)
    await call.answer()


# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ Ğ² Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ Ğ¸Ğ· Ñ†Ğ¸Ñ‚Ğ°Ñ‚Ñ‹
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
@router.callback_query(F.data == "main_menu_quote")
async def back_to_main(call: CallbackQuery):
    """
    Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¸Ğ· Ñ†Ğ¸Ñ‚Ğ°Ñ‚Ñ‹ Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ Ğ½Ğ¾Ğ²Ñ‹Ğ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ĞµĞ¼.
    """
    await call.message.edit_reply_markup(reply_markup=None)
    await call.answer()
    await call.message.answer(START_TEXT, reply_markup=get_main_menu_kb())


@router.callback_query(F.data == "main_menu_edit_quote")
async def back_to_main_from_quote(call: CallbackQuery):
    """
    ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ±ĞµĞ· Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ Ğ½Ğ°Ğ¶Ğ°Ğ» Â«Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½ÑÂ» Ğ¸Ğ· Ñ†Ğ¸Ñ‚Ğ°Ñ‚Ñ‹ â€”
    Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ.
    """
    await safe_call_answer(call)
    await call.message.edit_text(
        START_TEXT,
        reply_markup=get_main_menu_kb()
    )


# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ñ€Ğ¾ÑƒÑ‚ĞµÑ€Ğ°
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
def register_quote_handlers(dp):
    dp.include_router(router)
